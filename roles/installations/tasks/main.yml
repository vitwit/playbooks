---
- name: sleep for a few seconds
  command: sleep 20

- name: Debug the user dir
  debug:
    msg: "User Directory: {{ user_home }}"

- name: Download go tar file
  command: wget https://go.dev/dl/go{{go_version}}.linux-amd64.tar.gz
  become: true

- name: Delete previous installation
  command: rm -rf /usr/local/go
  become: true

- name: Extract and move new go folder to /usr/local
  command: tar -C /usr/local -xzf go{{go_version}}.linux-amd64.tar.gz
  become: true

- name: Delete downloaded tar file
  shell: rm -rf go{{go_version}}.linux-amd64.tar.gz*
  become: true

- name: Set Go environment variables in ~/.profile
  lineinfile:
    path: ~/.profile
    line: |
      export GOROOT=/usr/local/go 
      export GOPATH={{ user_home }}/go
      export GOBIN=$GOPATH/bin
      export PATH=$PATH:/usr/local/go/bin:$GOBIN
    create: true
    state: present

- name: sleep for a few seconds
  command: sleep 15

- name: Update apt package list
  become: true
  apt:
    update_cache: yes

- name: sleep for a few seconds
  command: sleep 30

- name: Install prerequisites
  become: true
  apt:
    name:
      - make
      - jq
      - gcc
    state: present

- name: Debug the  dir
  debug:
    msg: "User Directory: {{ user_home }}"

- name: Install the binary
  become: true
  block:
    - name: Clone the git repo
      git:
        repo: "{{ repo }}"
        dest: "{{ user_home }}/{{ network }}"
        version: "{{ node_version }}"
        update: yes
        force: yes

    - name: Install node
      command: "make install"
      args:
        chdir: "{{ user_home }}/{{ network }}"
      environment:
        PATH: "{{ path }}"
        GOPATH: "{{ user_home }}/go"
